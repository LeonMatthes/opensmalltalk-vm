<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OpenSmalltalk-VM documentation</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Building the VM</li><li class="chapter-item expanded "><a href="build-system.html"><strong aria-hidden="true">1.</strong> Build system</a></li><li class="chapter-item expanded "><a href="repository-structure.html"><strong aria-hidden="true">2.</strong> Repository Structure</a></li><li class="chapter-item expanded "><a href="vmmaker-image-creation.html"><strong aria-hidden="true">3.</strong> Creating a VMMaker image</a></li><li class="chapter-item expanded affix "><li class="part-title">Plugin development guide</li><li class="chapter-item expanded "><a href="plugin-development/plugin-creation.html"><strong aria-hidden="true">4.</strong> Plugin Creation</a></li><li class="chapter-item expanded "><a href="plugin-development/Slang.html"><strong aria-hidden="true">5.</strong> Slang (C code generation)</a></li><li class="chapter-item expanded affix "><li class="part-title">VM development</li><li class="chapter-item expanded "><a href="vm-development/garbage-collection.html"><strong aria-hidden="true">6.</strong> Garbage Collection</a></li><li class="chapter-item expanded "><a href="vm-development/vm-simulation.html"><strong aria-hidden="true">7.</strong> VM simulation</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">OpenSmalltalk-VM documentation</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the OpenSmalltalk-VM documentation.</p>
<p>This book serves as a way to provide you with entry points to get you started.
It does <em>not</em> aim to be a comprehensive reference.
More specific documentation can be found inside the classes and files that are linked from this book.</p>
<p>Depending on what you want to achieve with the OpenSmalltalk-VM, there are different areas that you might be interested in:</p>
<p>If you simply want to <strong>build</strong> the VM or troubleshoot problems during building, take a look at the <a href="./build-system.html">Build System</a>.</p>
<p>If you are interested in <strong>improving the VM or its plugins</strong>, you'll first want to set up a good development environment.
For this, see: <a href="./vmmaker-image-creation.html">Creating your VMMaker image</a>.
That page will also guide you through Setting up the documentation so that you can read and edit it from within Squeak.</p>
<p>After setting up your development environment, you can start reading:</p>
<ul>
<li><a href="./plugin-development/plugin-creation.html">Plugin Development</a></li>
<li><a href="./vm-development/SUMMARY.html">VM Development</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-system"><a class="header" href="#build-system">Build system</a></h1>
<p>The Opensmalltalk-VM supports many operating systems and architectures.
It should therefore be possible to build the VM for as many of these combinations as possible.</p>
<p>As outlined in the <a href="./repository-structure.html">Repository structure page</a>, the <code>building</code> folder of the repository contains subfolders for the possible VM configurations. See the <code>HowToBuild</code> files in the separate subfolders for an explanation of how to build each subdirectories VM configuration.</p>
<p>The following chapters only give a broad overview of each build system</p>
<h2 id="linux---autoconf"><a class="header" href="#linux---autoconf">Linux - Autoconf</a></h2>
<p>The linux builds use autoconf to build the VM.
For a quick overview, see <a href="https://www-f9.ijs.si/%7Estuden/blogs/posts/2015/Jun/05/autoconf-explained/">this page</a>.</p>
<p>The basic parts involved are:</p>
<ol>
<li><code>make configure</code> in the <code>platforms/unix/config</code> folder will generate a <code>configure</code> script.
This <code>configure</code> script is assembled from the different <code>*.m4</code> files found in the build system (e.g. the <code>platforms/unix/plugins/*</code> directories).</li>
<li><code>./configure</code> will try to find all your dependencies on your system and then generate the appropriate makefiles for the VM and its plugins.</li>
<li><code>make</code> will then build the actual VM.</li>
</ol>
<p>The <code>configure</code> script is usually checked into the repository, and therefore step 1 isn't required, unless you want to introduce a new dependency.</p>
<p>Steps 2 and 3 are also automated in <code>mvm</code> the scripts in the <code>building/linux64x64/</code> directories.
Therefore, most of the time you only need to go into the appropriate building directory and run <code>./mvm</code>.</p>
<p>If you <strong>do</strong> need to rebuild the configure script, you can do so by running <code>make configure</code> in the <code>platforms/unix/config/</code> directory of the repository.</p>
<h2 id="macos---makefiles"><a class="header" href="#macos---makefiles">MacOS - Makefiles</a></h2>
<p><strong>Note: In many parts of the build system, Mac OS is referred to as iOS for historic reasons.</strong></p>
<p>Mac OS uses plain Makefiles.
Just like in Linux, there exists a <code>mvm</code> script that wraps the make based build process.</p>
<p>The Makefiles in the <code>platforms/iOS/plugins</code> subfolders will be automatically included when building the plugin.
See the <code>platforms/iOS/plugins/BochsX64Plugin</code> folder for an example. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vm-source-directories"><a class="header" href="#vm-source-directories">VM source directories</a></h1>
<p>The Slang output of the various VMs are kept in &quot;vm source&quot; directories.  These
C sources define the core VM (the Smalltalk execution engine and the memory
manager), and a substantial set of &quot;plugins&quot; that provide interfaces to various
external facilities via Smalltalk primitive methods.  Each vm source directory
is specific to a particular VM, be it Squeak Cog Spur, or V3 Stack, etc.
The plugins can be shared between VMs, choosing the set of plugins to include
in a VM at build time (see plugins.int &amp; plugins.ext in build directories).</p>
<p>The VM source are in directories such as</p>
<pre><code>	src/v3.sista		- Smalltalk Sista V3
	src/spur32.sista	- Smalltalk Sista Spur
	src/spur32.cog 		- Smalltalk Cog Spur
	src/spur64.cog 		- Smalltalk Cog Spur 64-bit
	src/spur32.stack 	- Smalltalk Stack Spur
	src/spur64.stack 	- Smalltalk Stack Spur 64-bit
	src/v3.cog			- Smalltalk Cog V3
	src/v3.stack 		- Smalltalk Stack V3
</code></pre>
<p>All plugins are in the directory</p>
<pre><code>	src/plugins
</code></pre>
<p>These contain many, but not all, of the plugins available for the VM.  Others
can be found in Cog, or in various Monticello packages in various repositories.</p>
<p>Each vm source directory contains several files, a subset of the following:</p>
<pre><code>	cogit.c				- the JIT; a Cogit cooperates with a CoInterpreter.
                          This simply includes a processor-specific JIT file
	cogitIA32.c et al   - relevant processor-specific JIT, selected by cogit.c
	cogit.h				- the Cogit's API, as used by the CoInterpreter
	cogmethod.h			- the structure of a CogMethod, the output of the Cogit
	cointerp.c			- the CoInterpreter's source file
	cointerp.h			- the API of the CoInterpreter, as used by the Cogit
	cointerpmt.c		- the multi-threaded CoInterpreterMT's source file
	cointerpmt.h		- the API of the CoInterpreterMT, as used by the Cogit
	gcc3x-cointerp.c	- cointerp.c massaged to interpret faster if using gcc
	gcc3x-cointerpmt.c	- ditto for cointerpmt.c
	gcc3x-interp.c		- ditto for interp.c
	interp.c			- the StackInterpreter's source file
	interp.h			- defines for the VM configuration, word size, etc
	vmCallback.h		- the structure of the VM's VMCallbackContext
</code></pre>
<h1 id="platform-build-directories"><a class="header" href="#platform-build-directories">Platform build directories</a></h1>
<p>The current &quot;official&quot; build directories are of the form
building/OS_WordSize_Processor, and include</p>
<pre><code>	building/linux32x86	- uses autoconf, gcc and make
	building/macos32x86	- 32-bit Mac OS X using clang and gmake
	building/macos64x64	- 64-bit Mac OS X using clang and gmake
	building/win32x86		- uses cygwin, gcc and gmake
</code></pre>
<p>More can be added as required.  In each there is a HowToBuild that describes
the necessary steps to compile a VM.</p>
<p>Within each building/OS_WordSize_Processor directory are a set of build directories
for specific configurations of Cog, and for support code and makefiles.  For
example, there exist</p>
<pre><code>	building/macos32x86/squeak.cog.spur   - A Cog JIT VM with Squeak branding,
                                         using the Spur memory manager.
	building/macos32x86/squeak.stack.spur - A Stack interpreter VM with Squeak
                                         branding, and the Spur memory manager.
	building/macos32x86/squeak.cog.v3     - A Cog JIT VM with Squeak branding,
                                         using the old Squeak memory manager.
	building/macos32x86/pharo.cog.spur    - A Cog JIT VM with Pharo branding and
                                         plugins (not yet implemented) using the
                                         Spur memory manager.
</code></pre>
<pre><code>etc.
</code></pre>
<p>There exist</p>
<pre><code>    building/macos64x64/bochsx86 - Support libraries for the BochsIA32Plugin which
                                is used to develop Cog itself.
    building/macos64x64/bochsx64 - Support libraries for the BochsX64Plugin which
                                is used to develop Cog itself.
    building/macos64x64/gdbarm32 - Support libraries for the GdbARMPlugin which
                                is used to develop Cog itself.
    building/macos64x64/gdbarm64 - Support libraries for the GdbARMv8Plugin which
                                is used to develop Cog itself.
</code></pre>
<p>and the intention is to add such directories to contain e.g. support code for
the Pharo Cairo and Freetype plugins, and anything else needed.  By placing
support directories in each build directory they can be shared between various
branded VM builds, avoiding duplication.</p>
<p>There exist</p>
<pre><code>	building/macos32x86/common - Gnu Makefiles for building the various branded VMs
	building/macos64x64/common - Gnu Makefiles for building the various branded VMs
	building/win32x86/common   - Gnu Makefiles for building the various branded VMs
	building/win64x64/common   - Gnu Makefiles for building the various branded VMs
</code></pre>
<p>And the intention is to add building/linuxNN????/common as soon as possible to
use Gnu Makefiles to build all VMs on all platforms.</p>
<p>The scripts directory contains various scripts for validating and checking-in
generated sources, packaging builds into installable artifacts (tar, msi, zip),
and so on.  The linux builds and the packaging scripts produce outputs in the
products directory tree.  The packaging scripts may choose to include Smalltalk
source files included in the sources directory.</p>
<h1 id="other-directories"><a class="header" href="#other-directories">Other directories</a></h1>
<p>The platforms directory contains the associated platform-specific files that
combine with the Slang-generated source to produce complete VMs.  The structure
is</p>
<pre><code>	platforms/Cross/vm
	platforms/Cross/plugins
	platforms/iOS/vm
	platforms/iOS/plugins
	platforms/unix/vm*
	platforms/unix/plugins
	platforms/win32/vm
	platforms/win32/plugins
</code></pre>
<p>Each vm directory contains support for the core VM.  Each plugin directory
contains run-time and build-time support for various plugins.</p>
<p>The processors directory contains the source for various processor simulators.
The JIT is developed in Smalltalk by using one of these processor simulators
to execute the code the JIT produces.  Currently x86 &amp; x86-64 are derived from
Bochs, and ARMv6/v7 &amp; ARMv8 are derived from gdb.</p>
<p>Finally the image directory contains scripts that will build a &quot;VMMaker&quot; image,
a Squeak Smalltalk image containing all the packages that comprise the Cog
system, suitable for developing the VM and for generating (or updating) the
sources in the vm source directories. There is also a script for generating a
64-bit Spur image from a 32-bit Spur image.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-vmmaker-image"><a class="header" href="#the-vmmaker-image">The VMMaker image</a></h1>
<p>OpenSmalltalk-VM development is mostly done from within a working Squeak image called the VMMaker image.
This image contains the VM sources as well as tooling specific to Opensmalltalk-VM development.</p>
<p>The <code>image</code> folder contains multiple scripts to build yourself both a VMMaker image and a SpurReader image (see below).</p>
<p>Generally, the VMMaker image is just a normal trunk image that contains:</p>
<ul>
<li>The VM sources, downloaded in <code>BuildSpurTrunkVMMakerImage.st</code></li>
<li>Multiple Workspaces with useful code snippets
<ul>
<li>These are loaded from the <code>*.text</code> files in the <code>image</code> folder.</li>
</ul>
</li>
</ul>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<p>After you have built your VMMaker image, it's likely you won't have to build it again for a long time.
This does also mean that the scripts that build the VMMaker image aren't executed all that often.
Therefore they are likely out of date.</p>
<p>So don't expect them to work from the get-go, but be prepared to fix things here and there, and possibly to emulate what the scripts do yourself.</p>
<p>The good part is: Building the VMMaker image isn't all that complex.
You can try to get the entire script running, or read the scripts and perform them yourself, one step at a time and save your progress in-between.</p>
<h2 id="setting-up-squeak-help"><a class="header" href="#setting-up-squeak-help">Setting up Squeak Help</a></h2>
<p>If you set up the VM-Maker image correctly, opening the Squeak Help (Help &gt; Squeak Help) will allow you to browse this documentation from within Squeak directly.
Search for the <code>OpenSmalltalk-VM</code> entry.</p>
<p>As long as the Squeak Help can find this documentation on disk, it will be displayed there in a readable format.
I do recommend you install the <a href="https://github.com/hpi-swa-teaching/MarkdownEditor">Markdown Editor</a>.
That way, the markdown files will be syntax-highlighted and links will work.</p>
<p>The best thing about reading the documentation from within Squeak is that links that begin with <code>squeak://</code> are evaluated when clicked.
This means many parts of the documentation can directly link to helpful pieces of Smalltalk code or other parts of the Smalltalk eco-system.</p>
<p>Try it out: <a href="squeak://VMHelp%20helloWorld">Click me!</a></p>
<h2 id="spurreader-image"><a class="header" href="#spurreader-image">SpurReader image</a></h2>
<p>The SpurReader image isn't entirely necessary, but very helpful when simulating the VM. (See: <a href="./vm-development/vm-simulation.html">VM-Simulator</a>)</p>
<p>It is a very simple image that only waits for input from stdout and then evaluates the given input.
This makes it relatively simple to simulate, as there are less things going on, especially as the World is no longer stepping.</p>
<p>Note that the input for the SpurReader image is expected to be in <code>.st</code> format. Which means code segments are terminated with exclamation marks (<code>3 + 4</code> evaluates to 7).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="plugin-creation"><a class="header" href="#plugin-creation">Plugin Creation</a></h1>
<p>Plugins in Squeak are native binaries that inter-operate with the VM.</p>
<p>They can be categorized as either:</p>
<ul>
<li>internal (static libraries that are linked directly into the VM)</li>
<li>external (dynamic libraries that are loaded on demand)</li>
</ul>
<p>To understand how Plugins are built, have a read through the <a href="plugin-development/../build-system.html">Build System page</a>.</p>
<p>After you have <a href="plugin-development/../vmmaker-image-creation.html">set up your VMMaker image</a>, you can start creating a plugin from within Squeak.</p>
<p>Most plugins are written in <a href="plugin-development/./Slang.html">Slang</a> and are therefore developed from within Smalltalk.</p>
<h2 id="creating-your-own-plugin"><a class="header" href="#creating-your-own-plugin">Creating your own plugin</a></h2>
<p>To get started, create a subclass of <a href="squeak://InterpreterPlugin">InterpreterPlugin</a>.</p>
<p>Then you can get started writing your own Slang code.<br />
For example, add a class <code>MyPlugin</code>  as follows:</p>
<pre><code class="language-smalltalk">SmartSyntaxInterpreterPlugin subclass: #MyPlugin
	instanceVariableNames: ''
	classVariableNames: ''
	poolDictionaries: ''
	category: 'Playground'
</code></pre>
<p>with one member function:</p>
<pre><code class="language-smalltalk">primitiveSeven
	
	&quot;#primitive: Marks this method to be accessible as a primitive&quot;
	self primitive: 'primitiveSeven'.
	^ 3 + 4
</code></pre>
<p>See the aforementioned <a href="plugin-development/./Slang.html">Slang page</a> for instructions of how to transpile your Slang sources to C.</p>
<p>If you take a look at the <code>HowToBuild</code> file in the <code>building</code> folder for your operating system it should contain the information of how to add your Plugin to your build system.
Typically this simply means adding your plugin to a <code>plugins.ext</code> or <code>plugins.int</code> file, depending on whether you want an internal or external plugin.</p>
<p>After rebuilding the vm, you should then have a <code>MyPlugin</code> shared library somewhere (e.g. <code>MyPlugin.so</code>, <code>MyPlugin.dll</code>, etc.).</p>
<p>You can then define a function in another class like this:</p>
<pre><code>seven

	&lt;primitive: 'primitiveSeven' module: 'MyPlugin'&gt;
	^ self reportPrimitiveFailure
</code></pre>
<h2 id="linking-to-external-c-code"><a class="header" href="#linking-to-external-c-code">Linking to external C code</a></h2>
<p>Thus far, our plugin is self-contained and doesn't have any dependencies to anything other than Slang code.</p>
<p>Often times however, you will want to link to other C dependencies.
For this to work, you can simply call a function that you'll later define in C (or that already exists in C) with the appropriate arguments.</p>
<p>Take a look at the <a href="squeak://ProcessorSimulatorPlugin%3E%3E#primitiveNewCPU">ProcessorSimulatorPlugin&gt;&gt;#primitiveNewCPU</a> for an example.
In this function, <code>newCPU</code> is called, even though that function is not generated by Slang.
The simulator plugins, like the <a href="squeak://BochsX64Plugin">BochsX64Plugin</a> define these functions in C.</p>
<p>Any C file defined in <code>platforms/Cross/plugins/&lt;MyPluginName&gt;</code> will be compiled and linked into your plugin. See the <code>platforms/Cross/plugins/BochsX64Plugin/sqBochsX64Plugin.cpp</code> file for an example.
There you can define any code you need to wrap your C dependency to create an API that can be called from Slang.</p>
<p>The <code>platforms/&lt;YourOS&gt;/plugins/&lt;MyPluginName&gt;</code> folder can then be used to define special steps to perform during platform compilation.
For example <code>platforms/unix/plugins/BochsX64Plugin</code> folder contains files that are automatically included when recreating the configure script.
In the case of unix, this will contain a Makefile, as well as an <code>.m4</code> script.
See the <a href="plugin-development/../build-system.html">Build System</a> for more information of how the build system works.
I also recommend browsing the existing plugins code in the repository.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="slang"><a class="header" href="#slang">Slang</a></h1>
<p>Slang is a subset of Smalltalk, that is both:</p>
<ul>
<li>Valid Smalltalk code</li>
<li>Transpile-able to C</li>
</ul>
<p>It is written like normal Smalltalk code and can (mostly) be executed like normal Smalltalk.</p>
<p>For a more detailed Overview, see: <a href="http://wiki.squeak.org/squeak/2267">Squeak.org</a>.</p>
<h2 id="relevant-classes--packages"><a class="header" href="#relevant-classes--packages">Relevant Classes &amp; Packages</a></h2>
<h3 id="class-a-hrefsqueakvmmakertoolvmmakertoola"><a class="header" href="#class-a-hrefsqueakvmmakertoolvmmakertoola">Class: <a href="squeak://VMMakerTool">VMMakerTool</a></a></h3>
<p>An in-image GUI to generate C code for the VM or any external plugins.</p>
<p>Use <a href="squeak://VMMakerTool%20openInWorld"><code>VMMakerTool openInWorld</code></a> to open it.</p>
<p>Also see the <a href="squeak://ToolSet%20browseClassCommentOf:VMMakerTool"><strong>class comment</strong></a>.</p>
<h3 id="class-a-hrefsqueakvmmakervmmakera"><a class="header" href="#class-a-hrefsqueakvmmakervmmakera">Class: <a href="squeak://VMMaker">VMMaker</a></a></h3>
<p>This class is responsible for generating the different configurations of the OpenSmalltalk-VM from the in-image Slang sources.</p>
<p>Also see the <a href="squeak://ToolSet%20browseClassCommentOf:VMMaker"><strong>class comment</strong></a></p>
<h3 id="package-a-hrefsqueaktoolset20browsecategory20x27vmmaker-translation20to20cx27vmmaker-translation-to-ca"><a class="header" href="#package-a-hrefsqueaktoolset20browsecategory20x27vmmaker-translation20to20cx27vmmaker-translation-to-ca">Package: <a href="squeak://ToolSet%20browseCategory:%20#&#x27;VMMaker-Translation%20to%20C&#x27;">VMMaker-Translation to C</a></a></h3>
<p>Contains the code necessary for Slang-to-C code generation</p>
<p>The classes in here that start with <code>T</code> (i.e. <code>TParseNode</code> subclasses) represent nodes of the Slang <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a> that will be converted into C code.</p>
<h3 id="class-a-hrefsqueakccodegeneratorccodegeneratora"><a class="header" href="#class-a-hrefsqueakccodegeneratorccodegeneratora">Class: <a href="squeak://CCodeGenerator">CCodeGenerator</a></a></h3>
<p>The main entry point for Slang-to-C code generation.</p>
<p>See: <a href="squeak://CCodeGenerator%3E%3E#cCodeForMethod:">CCodeGenerator&gt;&gt;#cCodeForMethod:</a></p>
<p><a href="squeak://CogRTLOpcodes%20class%3E%3E#initialize">test</a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="young-and-old-space"><a class="header" href="#young-and-old-space">Young and Old Space</a></h2>
<p>Objects in Squeak are separated into a young and old space.
Newly allocated objects are (almost always) allocated in the young space.
When more space is needed, the young space is scavenged, and young objects that are no longer referenced are freed.</p>
<p>Young objects that survive multiple scavenging phases will be promoted into old space.</p>
<p>Old space is usually garbage collected when the VM runs out of allocated memory. (See Mark and Compact).</p>
<h2 id="mark-and-compact"><a class="header" href="#mark-and-compact">Mark and Compact</a></h2>
<p>Squeak currently does a stop-the-world Mark and Compact garbage collection.
See <a href="https://en.wikipedia.org/wiki/Mark%E2%80%93compact_algorithm">Wikipedia</a>.</p>
<h1 id="important-classes"><a class="header" href="#important-classes">Important Classes</a></h1>
<h2 id="a-hrefsqueakspurmemorymanagerspurmemorymanagera"><a class="header" href="#a-hrefsqueakspurmemorymanagerspurmemorymanagera"><a href="squeak://SpurMemoryManager">SpurMemoryManager</a></a></h2>
<p>Called whenever garbage collection needs to be started.</p>
<p>Does marking in a Mark&amp;Compact operation.
During marking, Forwarders are resolved.</p>
<p>Good entry points:</p>
<ul>
<li><a href="squeak://SpurMemoryManager%3E%3E#markAndTrace:">SpurMemoryManager&gt;&gt;#markAndTrace:</a></li>
<li><a href="squeak://SpurMemoryManager%3E%3E#globalGarbageCollect">SpurMemoryManager&gt;&gt;#globalGarbageCollect</a></li>
<li><a href="squeak://SpurMemoryManager%3E%3E#markLoopFrom:">SpurMemoryManager&gt;&gt;#markLoopFrom:</a></li>
</ul>
<p><em>Future</em>: Marking might be extracted from the SpurMemoryManager and moved into different marking strategies.</p>
<ul>
<li>SpurMarker (abstract super class)</li>
<li>SpurAllAtOnceMarker</li>
<li>SpurIncrementalMarker</li>
</ul>
<h2 id="a-hrefsqueakspurgenerationscavengerspurgenerationscavengera"><a class="header" href="#a-hrefsqueakspurgenerationscavengerspurgenerationscavengera"><a href="squeak://SpurGenerationScavenger">SpurGenerationScavenger</a></a></h2>
<p>Scavanges the young space.</p>
<p><a href="squeak://ToolSet%20browseClassCommentOf:SpurGenerationScavenger">Class comment</a> includes a link to a paper that explains the algorithm used.</p>
<p>Entry points:
<a href="squeak://SpurGenerationScavenger%3E%3E#scavenge:">SpurGenerationScavenger&gt;&gt;#scavenge:</a></p>
<h2 id="a-hrefsqueakspurplanningcompactorspurplanningcompactora"><a class="header" href="#a-hrefsqueakspurplanningcompactorspurplanningcompactora"><a href="squeak://SpurPlanningCompactor">SpurPlanningCompactor</a></a></h2>
<p>Does compaction on old space.</p>
<h3 id="3-phases"><a class="header" href="#3-phases">3 Phases</a></h3>
<ol>
<li>Plan where things go</li>
<li>Update the pointers</li>
<li>Relocate</li>
</ol>
<p>Entry Points:</p>
<ul>
<li><a href="squeak://SpurPlanningCompactor%3E%3E#compact">SpurPlanningCompactor&gt;&gt;#compact</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vm-simulation"><a class="header" href="#vm-simulation">VM Simulation</a></h1>
<p>As mentioned in the <a href="vm-development/../plugin-development/Slang.html">Slang documentation</a>, Slang is a Smalltalk subset.
This means it can also be executed as normal Smalltalk code and use the normal Smalltalk tooling.</p>
<p>Using this mechanism, almost all of the VM code can be executed as if it were normal Smalltalk code.
Combine that with a few methods that replicate behavior that is normally implemented in native C code, and you can have a VM running entirely inside the <a href="vm-development/../plugin-development/vmmaker-image-creation.html">VMMaker image</a>.</p>
<p>The VMMaker image contains a &quot;Simulation Workspace&quot; that includes code snippets for starting such a simulation.
Usually you should use the SpurReader image (see <a href="vm-development/../vmmaker-image-creation.html">vmmaker-image-creation.md</a>) as the image to load into this Simulation, as it is relatively simple and easy to control.</p>
<h2 id="building-a-simulator-plugin"><a class="header" href="#building-a-simulator-plugin">Building a Simulator plugin</a></h2>
<p>Modern versions of the OpenSmalltalk-VM use a JIT (called Cog) to improve VM performance.
Therefore we need a way to simulate the execution of native code for whatever our target Instruction set is.
See <a href="http://www.mirandabanda.org/cogblog/2008/12/12/simulate-out-of-the-bochs/">this blog post</a></p>
<p>For this purpose, multiple plugins exist:</p>
<ul>
<li>Bochs for x86</li>
<li>GDB for Arm &amp; Armv8</li>
</ul>
<p>...and possibly more in the future.</p>
<p>Code for these plugins can be found in multiple places:</p>
<ul>
<li><code>processors</code> - the main sources for the simulators</li>
<li><code>building/&lt;myOS&gt;/</code> - each OS folder should contain a subfolder for each processor.
<ul>
<li>e.g. <code>building/linux64x64/bochsx64</code></li>
</ul>
</li>
</ul>
<p>See the  <code>HowToBuild</code> file in your OSes <code>building</code> subfolder for instructions on how to build the required libraries.</p>
<h2 id="relevant-classes--packages-1"><a class="header" href="#relevant-classes--packages-1">Relevant Classes &amp; Packages</a></h2>
<h3 id="package-a-hrefsqueaktoolset20browsecategory20x27vmmaker-jitsimulationx27vmmaker-jitsimulationa"><a class="header" href="#package-a-hrefsqueaktoolset20browsecategory20x27vmmaker-jitsimulationx27vmmaker-jitsimulationa">Package: <a href="squeak://ToolSet%20browseCategory:%20#&#x27;VMMaker-JITSimulation&#x27;">VMMaker-JITSimulation</a></a></h3>
<p>Contains all the support code necessary for simulation.</p>
<h3 id="class-a-hrefsqueakcogvmsimulatorcogvmsimulatora"><a class="header" href="#class-a-hrefsqueakcogvmsimulatorcogvmsimulatora">Class: <a href="squeak://CogVMSimulator">CogVMSimulator</a></a></h3>
<p>The main entry point for VM simulation.
See the <strong>class comment</strong> for examples.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
